
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  firstName     String?
  lastName      String?
  role          Role     @default(CUSTOMER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // relations (future):
  carts         Cart[]
  orders        Order[]
}

enum Role {
  ADMIN
  CUSTOMER
}

model Product {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String?
  priceCents  Int      // store money as integer cents to avoid floating errors
  currency    String   @default("USD")
  sku         String?  @unique
  stockQty    Int      @default(0) // simple stock model for MVP
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orderItems  OrderItem[]
  cartItems   CartItem[]
}

model Cart {
  id         String      @id @default(cuid())
  userId     String?
  user       User?       @relation(fields: [userId], references: [id])
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  checkedOut Boolean     @default(false)

  items      CartItem[]
}

model CartItem {
  id         String   @id @default(cuid())
  cartId     String
  productId  String
  quantity   Int      @default(1)

  cart       Cart     @relation(fields: [cartId], references: [id])
  product    Product  @relation(fields: [productId], references: [id])

  @@unique([cartId, productId]) // one line per product in a cart
}

model Order {
  id           String      @id @default(cuid())
  userId       String
  user         User        @relation(fields: [userId], references: [id])
  totalCents   Int
  currency     String       @default("USD")
  status       OrderStatus  @default(PENDING)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  items        OrderItem[]
  payment      Payment?
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  FAILED
  FULFILLED
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  productId   String
  nameSnapshot String  // snapshot of product name at purchase time
  priceCents  Int      // snapshot price at purchase
  quantity    Int

  order       Order    @relation(fields: [orderId], references: [id])
  product     Product  @relation(fields: [productId], references: [id])
}

model Payment {
  id            String     @id @default(cuid())
  orderId       String     @unique
  provider      Provider
  providerRef   String?    // Stripe paymentIntent id or PayPal order id
  amountCents   Int
  currency      String     @default("USD")
  status        PayStatus  @default(INITIATED)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  order         Order      @relation(fields: [orderId], references: [id])
}

enum Provider {
  STRIPE
  PAYPAL
}

enum PayStatus {
  INITIATED
  REQUIRES_ACTION
  SUCCEEDED
  FAILED
}